AWSTemplateFormatVersion: 2010-09-09
Description: Resources to be created by the common stack

Parameters:
  pApplicationName:
    Description: Name of the application (all lowercase, no symbols or spaces)
    Type: String
    AllowedPattern: "[a-z0-9]{2,8}"
    Default: datalake
  pCustomBucketPrefix:
    Description: S3 Bucket Prefix if different from default. Must be a valid S3 Bucket name
    Type: String
    Default: sdlf
  pDataLakeAdminRoleArn:
    Description: Lake Formation Admin Role Arn
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/IAM/DataLakeAdminRoleArn
  pEnvironment:
    Description: Environment name
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/Misc/pEnv
  pNumBuckets:
    Description: Number of data lake buckets (3 or 1)
    Default: "3"
    Type: String
    AllowedValues: ["3", "1"]
    ConstraintDescription: Must specify 3 or 1
  pOrganizationName:
    Description: Name of the organization (all lowercase, no symbols or spaces)
    Type: String
    AllowedPattern: "[a-z0-9]{2,9}"
  pCloudWatchLogsRetentionInDays:
    Description: The number of days log events are kept in CloudWatch Logs
    Type: Number
    Default: 30
    AllowedValues:
      [
        1,
        3,
        5,
        7,
        14,
        30,
        60,
        90,
        120,
        150,
        180,
        365,
        400,
        545,
        731,
        1827,
        3653,
      ]

Resources:
  ######## KMS #########
  rKMSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ./nested-stacks/template-kms.yaml
      Tags:
        - Key: tagging-policy
          Value: !Sub ${pOrganizationName}-${pApplicationName}-${pEnvironment}-foundations

  ######## S3 #########
  rS3Stack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ./nested-stacks/template-s3.yaml
      Parameters:
        pApplicationName: !Ref pApplicationName
        pCustomBucketPrefix: !Ref pCustomBucketPrefix
        pEnvironment: !Ref pEnvironment
        pKMSKeyId: !GetAtt [rKMSStack, Outputs.oKMSKeyId]
        pLakeFormationDataAccessRole: !GetAtt [rKMSStack, Outputs.oLakeFormationDataAccessRole]
        pNumBuckets: !Ref pNumBuckets
        pOrganizationName: !Ref pOrganizationName
        pCloudWatchLogsRetentionInDays: !Ref pCloudWatchLogsRetentionInDays
      Tags:
        - Key: tagging-policy
          Value: !Sub ${pOrganizationName}-${pApplicationName}-${pEnvironment}-foundations

  ######## DYNAMODB #########
  rDynamoStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rS3Stack
    Properties:
      TemplateURL: ./nested-stacks/template-dynamo.yaml
      Parameters:
        pEnvironment: !Ref pEnvironment
        pKMSKeyId: !GetAtt [rKMSStack, Outputs.oKMSKeyId]
      Tags:
        - Key: tagging-policy
          Value: !Sub ${pOrganizationName}-${pApplicationName}-${pEnvironment}-foundations

  ######## GLUE REPLICATION #########
  rGlueReplicationStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rDynamoStack
    Properties:
      TemplateURL: ./nested-stacks/template-glue.yaml
      Parameters:
        pApplicationName: !Ref pApplicationName
        pDataQualityBucket: !GetAtt [rS3Stack, Outputs.oDataQualityBucket]
        pDataLakeAdminRoleArn: !Ref pDataLakeAdminRoleArn
        pEnvironment: !Ref pEnvironment
        pKMSKeyId: !GetAtt [rKMSStack, Outputs.oKMSKeyId]
        pOrganizationName: !Ref pOrganizationName
        pPipelineBucket: !GetAtt [rS3Stack, Outputs.oPipelineBucket]
        pCloudWatchLogsRetentionInDays: !Ref pCloudWatchLogsRetentionInDays
      Tags:
        - Key: tagging-policy
          Value: !Sub ${pOrganizationName}-${pApplicationName}-${pEnvironment}-foundations

  ######## SSM OUTPUTS #########
  rOrganizationSsm:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /SDLF/Misc/pOrg
      Type: String
      Value: !Ref pOrganizationName
      Description: Name of the Organization owning the datalake
  rApplicationSsm:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /SDLF/Misc/pApp
      Type: String
      Value: !Ref pApplicationName
      Description: Name of the Application
