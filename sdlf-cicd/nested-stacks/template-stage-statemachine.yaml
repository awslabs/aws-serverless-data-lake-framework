AWSTemplateFormatVersion: "2010-09-09"
Description: CICD pipelines to automate SDLF workflows

Parameters:
  pSharedDevOpsAccountId:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/Misc/DevOpsAccountId
  pEnvironment:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/Misc/pEnv
  pStageRepository:
    Type: String
    Default: cfn-stageA
  pStageName:
    Type: String
    Default: stageA
    # todo constraints (no hyphen, aZ)
  pSharedDevOpsAccountKmsKeyArn:
    Description: Arn of the KMS key in the Shared DevOps account
    Type: String
  pArtifactsBucket:
    Description: The artifactory bucket used by CodeBuild and CodePipeline
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/S3/CFNBucket
  pEventBridgeRepositoryTriggerRoleArn:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/IAM/EventBridgeRepositoryTriggerRoleArn

Mappings:
  pCodeCommitBranch:
    dev:
      branch: dev
    test:
      branch: test
    prod:
      branch: master

Resources:
  rStageStateMachinePipeline: # and that's why it cannot be here. own cicd module? cicd-pipeline? as we add pipeline to every stage
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: "{{resolve:ssm:/SDLF/CodeBuild/CodePipelineRole}}"
      Stages:
        -
          Name: Source
          Actions:
            -
              Name: Source
              RoleArn: !Sub arn:${AWS::Partition}:iam::${pSharedDevOpsAccountId}:role/sdlf-cicd-module-codecommit-${pEnvironment}
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: '1'
                Provider: CodeCommit
              OutputArtifacts:
                - Name: SourceArtifact
              Configuration:
                RepositoryName: !Ref pStageRepository
                BranchName: !FindInMap [pCodeCommitBranch, !Ref pEnvironment, branch]
                PollForSourceChanges: false
              RunOrder: 1
        -
          Name: Build
          Actions:
            -
              Name: Build
              InputArtifacts:
              - Name: SourceArtifact
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: '1'
                Provider: CodeBuild
              OutputArtifacts:
                - Name: BuildArtifact
              Configuration:
                ProjectName: "{{resolve:ssm:/SDLF/CodeBuild/BuildCloudformationModuleStage}}"
                EnvironmentVariables: !Sub '[{"name":"MODULE_NAME", "value":"${pStageName}", "type":"PLAINTEXT"}]'
              RunOrder: 1
      ArtifactStore:
        Type: S3
        EncryptionKey:
          Id: !Ref pSharedDevOpsAccountKmsKeyArn
          Type: KMS
        Location: !Ref pArtifactsBucket

  rStageStateMachineTriggerEventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: !Sub "Run Stage State Machine on ${pStageName} repository update"
      EventPattern:
        source:
          - aws.codecommit
        detail-type:
          - CodeCommit Repository State Change
        resources:
          - !Sub arn:${AWS::Partition}:codecommit:${AWS::Region}:${pSharedDevOpsAccountId}:${pStageRepository}
        detail:
          event:
            - referenceCreated
            - referenceUpdated
          referenceType:
            - branch
          referenceName:
            - dev
            - test
            - master
      Targets:
        - Arn: !Sub arn:${AWS::Partition}:codepipeline:${AWS::Region}:${AWS::AccountId}:${rStageStateMachinePipeline}
          Id: !Sub sdlf-${pStageRepository}-trigger
          RoleArn: !Ref pEventBridgeRepositoryTriggerRoleArn
